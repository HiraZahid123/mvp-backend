import{b as D,a as l,c as f,j as e,H as V,L as $,r as U}from"./app-DPEtfABQ.js";import{A as F}from"./AuthenticatedLayout-CMKzBOMo.js";import{u as H}from"./useTranslation-CHcCtFEc.js";import{P as B}from"./PaymentModal-DUA5w5FP.js";import"./transition-BwDj_57U.js";import"./LanguageSwitcher-CcbLJo8v.js";import"./Modal-Vq_CfrKQ.js";import"./PrimaryButton-Dgc-1MNe.js";import"./SecondaryButton-C62ts7gu.js";function ee({chats:S,selectedChatId:p}){const{t:r}=H(),{auth:o}=D().props,[c,G]=l.useState(S||[]),[t,T]=l.useState(null),[w,g]=l.useState([]),[x,k]=l.useState(""),[A,M]=l.useState(!1),[h,b]=l.useState([]),_=l.useRef(null),y=l.useRef(null),[I,E]=l.useState(null),[O,u]=l.useState(!1);l.useEffect(()=>{if(p&&c.length>0){const s=c.find(a=>a.id==p);s&&j(s)}else c.length>0&&j(c[0])},[p]),l.useEffect(()=>{_.current?.scrollIntoView({behavior:"smooth"})},[w,h]);const j=s=>{T(s),f.get(route("api.chats.messages",s.id)).then(a=>{g(a.data)}),t&&window.Echo.leave(`chat.${t.id}`),window.Echo.join(`chat.${s.id}`).here(a=>{console.log("Users in chat:",a)}).joining(a=>{console.log("User joined:",a)}).leaving(a=>{console.log("User left:",a),b(i=>i.filter(n=>n.id!==a.id))}).listen("MessageSent",a=>{console.log("MessageSent event received:",a);const i=a.message;console.log("Message data:",i),g(n=>n.find(v=>v.id===i.id)?(console.log("Message already exists, skipping"),n):(console.log("Adding new message to UI"),[...n,i]))}).listen("typing.indicator",a=>{console.log("Typing indicator:",a),a.userId!==o.user.id&&(a.isTyping?b(i=>[...i.filter(n=>n.id!==a.userId),{id:a.userId,name:a.userName}]):b(i=>i.filter(n=>n.id!==a.userId)))})},C=s=>{if(s.preventDefault(),!x.trim()||!t)return;const a=x;k(""),N(!1),f.post(route("api.chats.messages.store",t.id),{content:a}).then(i=>{console.log("Message sent successfully:",i.data),g(n=>n.find(v=>v.id===i.data.id)?n:[...n,i.data])}).catch(i=>{console.error("Failed to send message",i),i.response?.data?.error?alert(i.response.data.error):alert("Failed to send message. Please try again.")})},N=s=>{t&&(A!==s&&(M(s),f.post(route("api.chats.typing",t.id),{is_typing:s})),s&&(y.current&&clearTimeout(y.current),y.current=setTimeout(()=>{N(!1)},3e3)))},m=s=>{const a=s.participant_ids?.find(i=>i!==o.user.id);return s.mission?.user_id===a?{name:s.mission?.user?.name||"User",id:a}:{name:s.mission?.assigned_user?.name||"User",id:a}},d=s=>{if(!s?.mission?.offers)return null;const a=s.participant_ids?.find(n=>n!==o.user.id),i=s.mission.user_id===o.user.id?a:o.user.id;return s.mission.offers.find(n=>n.user_id===i&&n.status==="pending")},R=s=>{confirm(r("Are you sure you want to accept this offer? This will initiate the payment hold."))&&U.post(route("missions.select-offer",{mission:t.mission_id,offer:s.id}),{},{onSuccess:a=>{a.props.flash?.stripe_client_secret?(E(a.props.flash.stripe_client_secret),u(!0)):alert(r("Offer accepted successfully!"))},onError:()=>{alert(r("Failed to accept offer. Please try again."))}})},L=s=>{confirm(r("Are you sure you want to hire this person? This will initiate the payment hold for the mission budget."))&&f.post(route("missions.hire",{mission:t.mission_id,performer:s})).then(a=>{a.data.stripe_client_secret?(E(a.data.stripe_client_secret),u(!0)):(alert(r("Performer hired successfully!")),window.location.reload())}).catch(a=>{console.error("Failed to hire performer",a),alert(r("Failed to hire performer. Please try again."))})};return e.jsxs(F,{header:r("Messages"),children:[e.jsx(V,{title:r("Messages")}),e.jsxs("div",{className:"flex h-[calc(100vh-180px)] bg-oflem-cream",children:[e.jsxs("div",{className:"w-1/4 bg-white border-r border-gray-border flex flex-col",children:[e.jsx("div",{className:"p-6 border-b border-gray-border",children:e.jsx("h2",{className:"text-2xl font-black text-primary-black",children:r("Conversations")})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:c.length===0?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),e.jsx("p",{className:"text-gray-muted font-bold",children:r("No conversations yet")})]}):c.map(s=>{const a=m(s),i=t?.id===s.id;return e.jsx("button",{onClick:()=>j(s),className:`w-full p-5 border-b border-gray-border/30 hover:bg-oflem-cream/20 transition-all text-left ${i?"bg-oflem-cream/40 border-l-4 border-l-gold-accent":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gold-accent flex items-center justify-center text-primary-black font-black shrink-0",children:a.name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-black text-primary-black truncate",children:a.name}),e.jsx("span",{className:"text-[10px] text-gray-muted font-bold",children:s.last_message_at?new Date(s.last_message_at).toLocaleDateString():""})]}),e.jsxs("p",{className:"text-xs text-gray-muted font-bold mb-1 truncate",children:["ðŸ“‹ ",s.mission?.title||r("Mission")]}),e.jsx("p",{className:"text-xs text-gray-muted font-medium truncate",children:s.messages?.[0]?.content||r("Start a conversation")})]})]})},s.id)})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-6 bg-white border-b border-gray-border flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gold-accent flex items-center justify-center text-primary-black font-black",children:m(t).name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-black text-primary-black",children:m(t).name}),e.jsxs("p",{className:"text-sm text-gray-muted font-bold",children:["ðŸ“‹ ",t.mission?.title]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[w.map(s=>s.user_id===null||s.is_system_message?e.jsx("div",{className:"flex justify-center my-4",children:e.jsx("div",{className:"bg-oflem-cream/50 border border-gold-accent/30 px-6 py-3 rounded-2xl text-xs font-bold text-primary-black/70 text-center max-w-[80%]",children:s.content})},s.id):e.jsx("div",{className:`flex ${s.user_id===o.user.id?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] ${s.user_id===o.user.id?"":"flex items-start gap-2"}`,children:[s.user_id!==o.user.id&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gold-accent flex items-center justify-center text-primary-black font-black text-xs shrink-0",children:s.user?.name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{children:[e.jsx("div",{className:`p-4 rounded-[20px] text-sm font-medium shadow-sm ${s.user_id===o.user.id?"bg-primary-black text-white rounded-br-sm":"bg-white text-primary-black border border-gray-border rounded-bl-sm"}`,children:e.jsx("p",{children:s.content})}),e.jsx("span",{className:"text-[10px] text-gray-muted font-bold mt-1 block",children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},s.id)),h.length>0&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-center gap-2 bg-white border border-gray-border px-4 py-2 rounded-full shadow-sm",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),e.jsx("span",{className:"w-2 h-2 bg-gold-accent rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]}),e.jsxs("span",{className:"text-xs font-bold text-gray-muted",children:[h[0].name," ",r("is typing...")]})]})}),e.jsx("div",{ref:_})]}),e.jsx("form",{onSubmit:C,className:"p-6 bg-white border-t border-gray-border",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:x,onChange:s=>{k(s.target.value),N(!0)},placeholder:r("Type your message..."),className:"flex-1 bg-oflem-cream border-gray-border rounded-full px-6 py-4 text-sm font-medium focus:ring-2 focus:ring-gold-accent focus:border-transparent transition-all"}),e.jsx("button",{type:"submit",disabled:!x.trim(),className:"w-14 h-14 bg-primary-black text-white rounded-full flex items-center justify-center hover:bg-black transition-all disabled:opacity-30 shadow-lg",children:e.jsx("svg",{className:"w-6 h-6 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-8xl mb-6",children:"ðŸ’¬"}),e.jsx("h3",{className:"text-2xl font-black text-primary-black mb-2",children:r("Select a conversation")}),e.jsx("p",{className:"text-gray-muted font-bold",children:r("Choose a chat from the sidebar to start messaging")})]})})}),t&&e.jsxs("div",{className:"w-80 bg-white border-l border-gray-border flex flex-col overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-border",children:e.jsx("h3",{className:"text-lg font-black text-primary-black mb-2",children:r("Mission Details")})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Status")}),e.jsx("div",{className:`px-4 py-3 rounded-xl font-black text-sm text-center ${t.mission?.status==="OUVERTE"?"bg-blue-100 text-blue-700":t.mission?.status==="EN_NEGOCIATION"||t.mission?.status==="VERROUILLEE"?"bg-gold-accent/20 text-gold-accent":t.mission?.status==="EN_COURS"?"bg-yellow-100 text-yellow-700":t.mission?.status==="EN_VALIDATON"?"bg-orange-100 text-orange-700":t.mission?.status==="TERMINEE"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.mission?.status==="OUVERTE"?"ðŸ”“ "+r("Open"):t.mission?.status==="EN_NEGOCIATION"||t.mission?.status==="VERROUILLEE"?"âœ… "+r("Assigned"):t.mission?.status==="EN_COURS"?"â³ "+r("In Progress"):t.mission?.status==="EN_VALIDATON"?"âœ… "+r("In Validation"):t.mission?.status==="TERMINEE"?"âœ”ï¸ "+r("Completed"):r(t.mission?.status||"Unknown")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Budget")}),e.jsx("p",{className:"text-3xl font-black text-gold-accent",children:t.mission?.budget?`â‚¬${t.mission.budget}`:r("Not set")})]}),t.mission?.deadline&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Deadline")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"ðŸ“…"}),e.jsx("span",{className:"text-lg font-black text-primary-black",children:new Date(t.mission.deadline).toLocaleDateString()})]})]}),d(t)&&e.jsxs("div",{className:"p-4 bg-oflem-cream/20 border border-gold-accent/20 rounded-2xl space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-gray-muted font-black uppercase",children:r("Pending Offer")}),e.jsx("span",{className:"px-2 py-0.5 bg-gold-accent text-primary-black text-[10px] font-black rounded text-uppercase",children:r("Pending")})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsxs("span",{className:"text-2xl font-black text-primary-black",children:["â‚¬",d(t).amount]}),e.jsx("span",{className:"text-xs text-gray-muted font-bold",children:r("Proposed")})]}),d(t).message&&e.jsxs("p",{className:"text-xs text-primary-black/70 italic leading-relaxed",children:['"',d(t).message,'"']}),t.mission?.user_id===o.user.id&&e.jsx("button",{onClick:()=>R(d(t)),className:"w-full py-3 bg-gold-accent text-primary-black font-black rounded-full hover:shadow-lg transition-all text-sm",children:r("Accept Offer")})]}),!d(t)&&t.mission?.user_id===o.user.id&&t.mission?.status==="OUVERTE"&&e.jsxs("div",{className:"p-4 bg-primary-black/5 border border-primary-black/10 rounded-2xl space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-muted font-black uppercase mb-1",children:r("Ready to start?")}),e.jsx("p",{className:"text-sm text-primary-black font-bold",children:r("Hire this person immediately")})]}),e.jsxs("button",{onClick:()=>L(m(t).id),className:"w-full py-3 bg-primary-black text-white font-black rounded-full hover:bg-black transition-all text-sm shadow-md",children:["ðŸ’¼ ",r("Hire")," ",m(t).name]}),e.jsx("p",{className:"text-[10px] text-gray-muted text-center italic leading-tight",children:r("Hiring will secure the budget in escrow and assign the task.")})]}),t.mission?.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Description")}),e.jsx("p",{className:"text-sm text-primary-black font-medium leading-relaxed",children:t.mission.description})]}),e.jsxs($,{href:route("missions.show",t.mission_id),className:"w-full block text-center px-4 py-3 bg-primary-black text-white font-black rounded-full hover:bg-black transition-all",children:[r("View Full Mission")," â†’"]})]})]})]}),e.jsx(B,{show:O,clientSecret:I,onClose:()=>u(!1),onSuccess:()=>{u(!1),U.reload()}})]})}export{ee as default};
