import{b as F,a as n,c as u,j as e,H,L as $,r as C}from"./app-QnVUizLf.js";import{A as B}from"./AuthenticatedLayout-BiYnB1-m.js";import{u as G}from"./useTranslation-x70bPv3T.js";import{u as q,a as S,R as W,A as Y}from"./Header-Bh-tmRrQ.js";import{C as J,H as K,P as Q}from"./PaymentModal-C6xyYf8k.js";import{F as U}from"./file-text-DB24DGsM.js";import{S as X}from"./send-BiUsgE54.js";import{C as Z}from"./clock-jcWRqXiX.js";import{C as ee}from"./circle-check-big-ZCEYvisU.js";import{C as se}from"./calendar-yunnyVMs.js";import{B as te}from"./briefcase-CqmQ5bSX.js";import"./Footer-BK0BU5M7.js";import"./createLucideIcon-ouguqvvq.js";import"./transition-DT5QNeAT.js";import"./circle-user-CKxVRQcr.js";import"./Modal-FWEpfF1S.js";import"./PrimaryButton-BLT60-sn.js";import"./SecondaryButton-BiouIW42.js";function ve({chats:T,selectedChatId:h}){const{t:r}=G(),{auth:o}=F().props,[c,ae]=n.useState(T||[]),[t,A]=n.useState(null),[w,g]=n.useState([]),[x,_]=n.useState(""),[M,I]=n.useState(!1),[p,b]=n.useState([]),k=n.useRef(null),j=n.useRef(null),[O,E]=n.useState(null),[R,f]=n.useState(!1),{playSound:P}=q();n.useEffect(()=>{if(h&&c.length>0){const s=c.find(a=>a.id==h);s&&N(s)}else c.length>0&&N(c[0])},[h]),n.useEffect(()=>{k.current?.scrollIntoView({behavior:"smooth"})},[w,p]);const N=s=>{A(s),u.get(route("api.chats.messages",s.id)).then(a=>{g(a.data)}),t&&window.Echo.leave(`chat.${t.id}`),window.Echo.join(`chat.${s.id}`).here(a=>{console.log("Users in chat:",a)}).joining(a=>{console.log("User joined:",a)}).leaving(a=>{console.log("User left:",a),b(i=>i.filter(l=>l.id!==a.id))}).listen(".MessageSent",a=>{console.log("MessageSent event received:",a);const i=a.message;console.log("Message data:",i),g(l=>l.find(v=>v.id===i.id)?(console.log("Message already exists, skipping"),l):(console.log("Adding new message to UI"),Number(i.user_id)!==Number(o.user.id)&&P(),[...l,i]))}).listen(".typing.indicator",a=>{console.log("Typing indicator:",a),a.userId!==o.user.id&&(a.isTyping?b(i=>[...i.filter(l=>l.id!==a.userId),{id:a.userId,name:a.userName}]):b(i=>i.filter(l=>l.id!==a.userId)))})},z=s=>{if(s.preventDefault(),!x.trim()||!t)return;const a=x;_(""),y(!1),u.post(route("api.chats.messages.store",t.id),{content:a}).then(i=>{console.log("Message sent successfully:",i.data),g(l=>l.find(v=>v.id===i.data.id)?l:[...l,i.data])}).catch(i=>{console.error("Failed to send message",i),i.response?.data?.error?alert(i.response.data.error):alert("Failed to send message. Please try again.")})},y=s=>{t&&(M!==s&&(I(s),u.post(route("api.chats.typing",t.id),{is_typing:s})),s&&(j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{y(!1)},3e3)))},m=s=>{const a=s.participant_ids?.find(i=>i!==o.user.id);return s.mission?.user_id===a?{name:s.mission?.user?.name||"User",id:a}:{name:s.mission?.assigned_user?.name||"User",id:a}},d=s=>{if(!s?.mission?.offers)return null;const a=s.participant_ids?.find(l=>l!==o.user.id),i=s.mission.user_id===o.user.id?a:o.user.id;return s.mission.offers.find(l=>l.user_id===i&&l.status==="pending")},D=s=>{confirm(r("Are you sure you want to accept this offer? This will initiate the payment hold."))&&C.post(route("missions.select-offer",{mission:t.mission_id,offer:s.id}),{},{onSuccess:a=>{a.props.flash?.stripe_client_secret?(E(a.props.flash.stripe_client_secret),f(!0)):alert(r("Offer accepted successfully!"))},onError:()=>{alert(r("Failed to accept offer. Please try again."))}})},L=s=>{confirm(r("Are you sure you want to hire this person? This will initiate the payment hold for the mission budget."))&&u.post(route("missions.hire",{mission:t.mission_id,provider:s})).then(a=>{a.data.stripe_client_secret?(E(a.data.stripe_client_secret),f(!0)):(alert(r("Provider hired successfully!")),window.location.reload())}).catch(a=>{console.error("Failed to hire provider",a),alert(r("Failed to hire provider. Please try again."))})};return e.jsxs(B,{header:r("Messages"),maxWidth:"max-w-full",paddingY:"py-0",children:[e.jsx(H,{title:r("Messages")}),e.jsxs("div",{className:"flex h-[calc(100vh-144px)] bg-oflem-cream -mx-4 sm:-mx-6 lg:-mx-8",children:[e.jsxs("div",{className:"w-1/4 bg-white border-r border-gray-border flex flex-col",children:[e.jsx("div",{className:"p-6 border-b border-gray-border",children:e.jsx("h2",{className:"text-2xl font-black text-oflem-charcoal",children:r("Conversations")})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:c.length===0?e.jsxs("div",{className:"p-8 text-center mt-20",children:[e.jsx("div",{className:"w-16 h-16 bg-oflem-cream rounded-full flex items-center justify-center mx-auto mb-4 text-oflem-terracotta/40",children:e.jsx(S,{size:32})}),e.jsx("p",{className:"text-gray-muted font-bold",children:r("No conversations yet")})]}):c.map(s=>{const a=m(s),i=t?.id===s.id;return e.jsx("button",{onClick:()=>N(s),className:`w-full p-5 border-b border-gray-border/30 hover:bg-oflem-cream/20 transition-all text-left ${i?"bg-oflem-cream/40 border-l-4 border-l-oflem-terracotta":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light flex items-center justify-center text-oflem-charcoal font-black shrink-0",children:a.name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-black text-oflem-charcoal truncate",children:a.name}),e.jsx("span",{className:"text-[10px] text-gray-muted font-bold",children:s.last_message_at?new Date(s.last_message_at).toLocaleDateString():""})]}),e.jsxs("p",{className:"text-xs text-gray-muted font-bold mb-1 truncate flex items-center gap-1.5",children:[e.jsx(U,{size:10,className:"text-oflem-terracotta"})," ",s.mission?.title||r("Mission")]}),e.jsx("p",{className:"text-xs text-gray-muted font-medium truncate",children:s.messages?.[0]?.content||r("Start a conversation")})]})]})},s.id)})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-6 bg-white border-b border-gray-border flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light flex items-center justify-center text-oflem-charcoal font-black",children:m(t).name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-black text-oflem-charcoal",children:m(t).name}),e.jsxs("p",{className:"text-sm text-gray-muted font-bold flex items-center gap-1.5 mt-1",children:[e.jsx(U,{size:12,className:"text-oflem-terracotta"})," ",t.mission?.title]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[w.map(s=>s.user_id===null||s.is_system_message?e.jsx("div",{className:"flex justify-center my-4",children:e.jsx("div",{className:"bg-oflem-cream/50 border border-oflem-terracotta/30 px-6 py-3 rounded-2xl text-xs font-bold text-oflem-charcoal/70 text-center max-w-[80%]",children:s.content})},s.id):e.jsx("div",{className:`flex ${Number(s.user_id)===Number(o.user.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] ${Number(s.user_id)===Number(o.user.id)?"":"flex items-start gap-2"}`,children:[Number(s.user_id)!==Number(o.user.id)&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light flex items-center justify-center text-oflem-charcoal font-black text-xs shrink-0",children:s.user?.name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{children:[e.jsx("div",{className:`p-4 rounded-[20px] text-sm font-medium shadow-sm ${Number(s.user_id)===Number(o.user.id)?"bg-oflem-charcoal text-white rounded-br-sm":"bg-white text-oflem-charcoal border border-gray-border rounded-bl-sm"}`,children:e.jsx("p",{children:s.content})}),e.jsx("span",{className:"text-[10px] text-gray-muted font-bold mt-1 block",children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},s.id)),p.length>0&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-center gap-2 bg-white border border-gray-border px-4 py-2 rounded-full shadow-sm",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),e.jsx("span",{className:"w-2 h-2 bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]}),e.jsxs("span",{className:"text-xs font-bold text-gray-muted",children:[p[0].name," ",r("is typing...")]})]})}),e.jsx("div",{ref:k})]}),e.jsx("form",{onSubmit:z,className:"p-6 bg-white border-t border-gray-border",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:x,onChange:s=>{_(s.target.value),y(!0)},placeholder:r("Type your message..."),className:"flex-1 bg-oflem-cream border-gray-border rounded-full px-6 py-4 text-sm font-medium focus:ring-2 focus:ring-oflem-terracotta focus:border-transparent transition-all"}),e.jsx("button",{type:"submit",disabled:!x.trim(),className:"w-14 h-14 bg-oflem-charcoal text-white rounded-full flex items-center justify-center hover:bg-black transition-all disabled:opacity-30 shadow-lg group",children:e.jsx(X,{size:24,className:"group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-6 text-oflem-terracotta/20",children:e.jsx(S,{size:48})}),e.jsx("h3",{className:"text-2xl font-black text-oflem-charcoal mb-2",children:r("Select a conversation")}),e.jsx("p",{className:"text-gray-muted font-bold",children:r("Choose a chat from the sidebar to start messaging")})]})})}),t&&e.jsxs("div",{className:"w-80 bg-white border-l border-gray-border flex flex-col overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-border",children:e.jsx("h3",{className:"text-lg font-black text-oflem-charcoal mb-2",children:r("Mission Details")})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Status")}),e.jsx("div",{className:`px-4 py-3 rounded-xl font-black text-sm text-center ${t.mission?.status==="OUVERTE"?"bg-blue-100 text-blue-700":t.mission?.status==="EN_NEGOCIATION"||t.mission?.status==="VERROUILLEE"?"bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light/20 text-oflem-terracotta":t.mission?.status==="EN_COURS"?"bg-yellow-100 text-yellow-700":t.mission?.status==="EN_VALIDATON"?"bg-orange-100 text-orange-700":t.mission?.status==="TERMINEE"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.mission?.status==="OUVERTE"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(J,{size:10,fill:"currentColor",className:"text-blue-500"})," ",r("Open")]}):t.mission?.status==="EN_NEGOCIATION"||t.mission?.status==="VERROUILLEE"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(K,{size:14})," ",r("Assigned")]}):t.mission?.status==="EN_COURS"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(W,{size:14,className:"animate-spin-slow"})," ",r("In Progress")]}):t.mission?.status==="EN_VALIDATON"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(Z,{size:14})," ",r("In Validation")]}):t.mission?.status==="TERMINEE"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(ee,{size:14})," ",r("Completed")]}):r(t.mission?.status||"Unknown")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Budget")}),e.jsx("p",{className:"text-3xl font-black text-oflem-terracotta",children:t.mission?.budget?`€${t.mission.budget}`:r("Not set")})]}),t.mission?.deadline&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Deadline")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{size:18,className:"text-oflem-terracotta"}),e.jsx("span",{className:"text-lg font-black text-oflem-charcoal",children:new Date(t.mission.deadline).toLocaleDateString()})]})]}),d(t)&&e.jsxs("div",{className:"p-4 bg-oflem-cream/20 border border-oflem-terracotta/20 rounded-2xl space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-gray-muted font-black uppercase",children:r("Pending Offer")}),e.jsx("span",{className:"px-2 py-0.5 bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light text-oflem-charcoal text-[10px] font-black rounded text-uppercase",children:r("Pending")})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsxs("span",{className:"text-2xl font-black text-oflem-charcoal",children:["€",d(t).amount]}),e.jsx("span",{className:"text-xs text-gray-muted font-bold",children:r("Proposed")})]}),d(t).message&&e.jsxs("p",{className:"text-xs text-oflem-charcoal/70 italic leading-relaxed",children:['"',d(t).message,'"']}),t.mission?.user_id===o.user.id&&e.jsx("button",{onClick:()=>D(d(t)),className:"w-full py-3 bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light text-oflem-charcoal font-black rounded-full hover:shadow-lg transition-all text-sm",children:r("Accept Offer")})]}),!d(t)&&t.mission?.user_id===o.user.id&&t.mission?.status==="OUVERTE"&&e.jsxs("div",{className:"p-4 bg-oflem-charcoal/5 border border-oflem-charcoal/10 rounded-2xl space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-muted font-black uppercase mb-1",children:r("Ready to start?")}),e.jsx("p",{className:"text-sm text-oflem-charcoal font-bold",children:r("Hire this person immediately")})]}),e.jsxs("button",{onClick:()=>L(m(t).id),className:"w-full py-3 bg-oflem-charcoal text-white font-black rounded-full hover:bg-black transition-all text-sm shadow-md flex items-center justify-center gap-2",children:[e.jsx(te,{size:16})," ",r("Hire")," ",m(t).name]}),e.jsx("p",{className:"text-[10px] text-gray-muted text-center italic leading-tight",children:r("Hiring will secure the budget in escrow and assign the task.")})]}),t.mission?.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:r("Description")}),e.jsx("p",{className:"text-sm text-oflem-charcoal font-medium leading-relaxed",children:t.mission.description})]}),e.jsxs($,{href:route("missions.show",t.mission_id),className:"w-full block text-center px-4 py-3 bg-oflem-charcoal text-white font-black rounded-full hover:bg-black transition-all",children:[r("View Full Mission")," ",e.jsx(Y,{size:16,className:"inline ml-1"})]})]})]})]}),e.jsx(Q,{show:R,clientSecret:O,onClose:()=>f(!1),onSuccess:()=>{f(!1),C.reload()}})]})}export{ve as default};
