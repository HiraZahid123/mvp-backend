import{b as W,a as n,c as x,j as e,H as Z,L as Y,r as R}from"./app-DGZpcoEf.js";import{A as J}from"./AuthenticatedLayout-QvHA3J9k.js";import{u as K}from"./useTranslation-B70rtC_o.js";import{u as Q,a as U,R as X,A as ee}from"./Header-BmoeIyjT.js";import{C as te,H as se,P as ae}from"./PaymentModal-DpH-NCud.js";import{F as M}from"./file-text-V2Pruf3w.js";import{Z as re}from"./zap-BpTSWDMP.js";import{C as O}from"./circle-check-big-BrgJLQDx.js";import{S as I}from"./send-U1ov25GA.js";import{C as z}from"./clock-D9NFEChb.js";import{L as ie}from"./lock-CwqiprT_.js";import{C as le}from"./calendar-CuGAQ-oE.js";import{B as oe}from"./briefcase-Dj9NkFCF.js";import"./Footer-B6M1zDSw.js";import"./createLucideIcon-Jm3AEVgt.js";import"./transition-x_x8a0JL.js";import"./circle-user-B8B-okVQ.js";import"./Modal-CaaODvU6.js";import"./with-selector-pZowTde5.js";import"./PrimaryButton-giitCT6x.js";import"./SecondaryButton-CLZzXx2Z.js";function Te({chats:D,selectedChatId:b}){const{t:a}=K(),{auth:o}=W().props,[c,j]=n.useState(D||[]),[s,h]=n.useState(null),[E,y]=n.useState([]),[d,N]=n.useState(""),[P,L]=n.useState(!1),[v,w]=n.useState([]),S=n.useRef(null),k=n.useRef(null),[V,T]=n.useState(null),[q,p]=n.useState(!1),{playSound:F}=Q();n.useEffect(()=>{if(b&&c.length>0){const t=c.find(r=>r.id==b);t&&_(t)}else c.length>0&&_(c[0])},[b]),n.useEffect(()=>{S.current?.scrollIntoView({behavior:"smooth"})},[E,v]);const _=t=>{h(t),x.get(route("api.chats.messages",t.id)).then(r=>{y(r.data)}),s&&window.Echo.leave(`chat.${s.id}`),window.Echo.join(`chat.${t.id}`).here(r=>{console.log("Users in chat:",r)}).joining(r=>{console.log("User joined:",r)}).leaving(r=>{console.log("User left:",r),w(i=>i.filter(l=>l.id!==r.id))}).listen(".MessageSent",r=>{console.log("MessageSent event received:",r);const i=r.message;console.log("Message data:",i),y(l=>l.find(C=>C.id===i.id)?(console.log("Message already exists, skipping"),l):(console.log("Adding new message to UI"),Number(i.user_id)!==Number(o.user.id)&&F(),[...l,i]))}).listen(".typing.indicator",r=>{console.log("Typing indicator:",r),r.userId!==o.user.id&&(r.isTyping?w(i=>[...i.filter(l=>l.id!==r.userId),{id:r.userId,name:r.userName}]):w(i=>i.filter(l=>l.id!==r.userId)))})},A=t=>{if(t.preventDefault(),!d.trim()||!s)return;if(s.status==="rejected"){alert(a("This chat request has been declined."));return}const r=d;N(""),g(!1),x.post(route("api.chats.messages.store",s.id),{content:r}).then(i=>{console.log("Message sent successfully:",i.data),s.status==="pending"&&s.mission?.user_id===o.user.id&&(h(l=>({...l,status:"active"})),j(l=>l.map(f=>f.id===s.id?{...f,status:"active"}:f))),y(l=>l.find(C=>C.id===i.data.id)?l:[...l,i.data])}).catch(i=>{console.error("Failed to send message",i),i.response?.data?.error?alert(i.response.data.error):alert("Failed to send message. Please try again.")})},g=t=>{s&&(P!==t&&(L(t),x.post(route("api.chats.typing",s.id),{is_typing:t})),t&&(k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{g(!1)},3e3)))},u=t=>{const r=t.participant_ids?.find(i=>i!==o.user.id);return t.mission?.user_id===r?{name:t.mission?.user?.name||"User",id:r}:{name:t.mission?.assigned_user?.name||"User",id:r}},m=t=>{if(!t?.mission?.offers)return null;const r=t.participant_ids?.find(l=>l!==o.user.id),i=t.mission.user_id===o.user.id?r:o.user.id;return t.mission.offers.find(l=>l.user_id===i&&l.status==="pending")},H=t=>{confirm(a("Are you sure you want to accept this offer? This will initiate the payment hold."))&&R.post(route("missions.select-offer",{mission:s.mission_id,offer:t.id}),{},{onSuccess:r=>{r.props.flash?.stripe_client_secret?(T(r.props.flash.stripe_client_secret),p(!0)):alert(a("Offer accepted successfully!"))},onError:()=>{alert(a("Failed to accept offer. Please try again."))}})},$=t=>{confirm(a("Are you sure you want to hire this person? This will initiate the payment hold for the mission budget."))&&x.post(route("missions.hire",{mission:s.mission_id,provider:t})).then(r=>{r.data.stripe_client_secret?(T(r.data.stripe_client_secret),p(!0)):(alert(a("Provider hired successfully!")),window.location.reload())}).catch(r=>{console.error("Failed to hire provider",r),alert(a("Failed to hire provider. Please try again."))})},B=()=>{x.post(route("api.chats.accept",s.id)).then(()=>{h(t=>({...t,status:"active"})),j(t=>t.map(r=>r.id===s.id?{...r,status:"active"}:r))})},G=()=>{confirm(a("Are you sure you want to decline this chat request?"))&&x.post(route("api.chats.reject",s.id)).then(()=>{h(t=>({...t,status:"rejected"})),j(t=>t.map(r=>r.id===s.id?{...r,status:"rejected"}:r))})};return e.jsxs(J,{header:a("Messages"),maxWidth:"max-w-full",paddingY:"py-0",children:[e.jsx(Z,{title:a("Messages")}),e.jsxs("div",{className:"flex h-[calc(100vh-144px)] bg-oflem-cream -mx-4 sm:-mx-6 lg:-mx-8",children:[e.jsxs("div",{className:"w-1/4 bg-white border-r border-gray-border flex flex-col",children:[e.jsx("div",{className:"p-6 border-b border-gray-border",children:e.jsx("h2",{className:"text-2xl font-black text-oflem-charcoal",children:a("Conversations")})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:c.length===0?e.jsxs("div",{className:"p-8 text-center mt-20",children:[e.jsx("div",{className:"w-16 h-16 bg-oflem-cream rounded-full flex items-center justify-center mx-auto mb-4 text-oflem-terracotta/40",children:e.jsx(U,{size:32})}),e.jsx("p",{className:"text-gray-muted font-bold",children:a("No conversations yet")})]}):c.map(t=>{const r=u(t),i=s?.id===t.id;return e.jsx("button",{onClick:()=>_(t),className:`w-full p-5 border-b border-gray-border/30 hover:bg-oflem-cream/20 transition-all text-left ${i?"bg-oflem-cream/40 border-l-4 border-l-oflem-terracotta":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light flex items-center justify-center text-oflem-charcoal font-black shrink-0",children:r.name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-black text-oflem-charcoal truncate",children:r.name}),e.jsx("span",{className:"text-[10px] text-gray-muted font-bold",children:t.last_message_at?new Date(t.last_message_at).toLocaleDateString():""})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-xs text-gray-muted font-bold truncate flex items-center gap-1.5",children:[e.jsx(M,{size:10,className:"text-oflem-terracotta"})," ",t.mission?.title||a("Mission")]}),t.status==="pending"&&e.jsx("span",{className:"text-[10px] bg-oflem-terracotta/10 text-oflem-terracotta px-1.5 py-0.5 rounded font-black uppercase",children:a("Pending")}),t.status==="rejected"&&e.jsx("span",{className:"text-[10px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded font-black uppercase",children:a("Declined")})]}),e.jsx("p",{className:"text-xs text-gray-muted font-medium truncate mt-1",children:t.messages?.[0]?.content||a("Start a conversation")})]})]})},t.id)})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-6 bg-white border-b border-gray-border flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light flex items-center justify-center text-oflem-charcoal font-black",children:u(s).name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-black text-oflem-charcoal",children:u(s).name}),e.jsxs("p",{className:"text-sm text-gray-muted font-bold flex items-center gap-1.5 mt-1",children:[e.jsx(M,{size:12,className:"text-oflem-terracotta"})," ",s.mission?.title]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[E.map(t=>t.user_id===null||t.is_system_message?e.jsx("div",{className:"flex justify-center my-4",children:e.jsx("div",{className:"elegant-capsule !px-6 !py-3 !bg-oflem-cream/50 text-xs font-bold text-oflem-charcoal/70 text-center max-w-[80%]",children:t.content})},t.id):e.jsx("div",{className:`flex ${Number(t.user_id)===Number(o.user.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] ${Number(t.user_id)===Number(o.user.id)?"":"flex items-start gap-2"}`,children:[Number(t.user_id)!==Number(o.user.id)&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light flex items-center justify-center text-oflem-charcoal font-black text-xs shrink-0",children:t.user?.name?.charAt(0)?.toUpperCase()||"U"}),e.jsxs("div",{children:[e.jsx("div",{className:`p-4 rounded-[20px] text-sm font-medium shadow-sm ${Number(t.user_id)===Number(o.user.id)?"bg-oflem-charcoal text-white rounded-br-sm":"bg-white text-oflem-charcoal border border-gray-border rounded-bl-sm"}`,children:e.jsx("p",{children:t.content})}),e.jsx("span",{className:"text-[10px] text-gray-muted font-bold mt-1 block",children:new Date(t.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},t.id)),v.length>0&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-center gap-2 bg-white border border-gray-border px-4 py-2 rounded-full shadow-sm",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),e.jsx("span",{className:"w-2 h-2 bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]}),e.jsxs("span",{className:"text-xs font-bold text-gray-muted",children:[v[0].name," ",a("is typing...")]})]})}),e.jsx("div",{ref:S})]}),e.jsx("div",{className:"p-6 bg-white border-t border-gray-border",children:s.status==="pending"&&s.mission?.user_id===o.user.id?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-oflem-cream/30 rounded-2xl border border-gray-border/50",children:[e.jsx("div",{className:"w-10 h-10 bg-oflem-terracotta/10 text-oflem-terracotta rounded-full flex items-center justify-center shrink-0",children:e.jsx(re,{size:20})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-black text-oflem-charcoal",children:a("Chat Request")}),e.jsx("p",{className:"text-xs text-gray-muted font-medium",children:a("The provider would like to chat about this mission.")})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:B,className:"flex-1 py-4 bg-oflem-charcoal text-white font-black rounded-full hover:bg-black transition-all flex items-center justify-center gap-2",children:[e.jsx(O,{size:18})," ",a("Accept Request")]}),e.jsx("button",{onClick:G,className:"px-8 py-4 bg-gray-100 text-gray-700 font-black rounded-full hover:bg-gray-200 transition-all",children:a("Decline")})]}),e.jsxs("div",{className:"relative flex items-center py-2",children:[e.jsx("div",{className:"flex-grow border-t border-gray-border"}),e.jsx("span",{className:"flex-shrink mx-4 text-xs font-black text-gray-muted uppercase tracking-widest",children:a("Or simply reply")}),e.jsx("div",{className:"flex-grow border-t border-gray-border"})]}),e.jsxs("form",{onSubmit:A,className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:d,onChange:t=>{N(t.target.value),g(!0)},placeholder:a("Type your reply to automatically accept..."),className:"flex-1 bg-oflem-cream border-gray-border rounded-full px-6 py-4 text-sm font-medium focus:ring-2 focus:ring-oflem-terracotta focus:border-transparent transition-all"}),e.jsx("button",{type:"submit",disabled:!d.trim(),className:"w-14 h-14 bg-oflem-charcoal text-white rounded-full flex items-center justify-center hover:bg-black transition-all disabled:opacity-30 shadow-lg",children:e.jsx(I,{size:24})})]})]}):s.status==="pending"&&s.mission?.user_id!==o.user.id?e.jsxs("div",{className:"text-center p-6 bg-oflem-cream/30 rounded-2xl border border-gray-border/50",children:[e.jsx("div",{className:"w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-oflem-terracotta/40",children:e.jsx(z,{size:24})}),e.jsx("p",{className:"text-sm font-black text-oflem-charcoal mb-1",children:a("Request Pending")}),e.jsx("p",{className:"text-xs text-gray-muted font-medium italic",children:a("Waiting for the client to accept your chat request.")})]}):s.status==="rejected"?e.jsxs("div",{className:"text-center p-6 bg-red-50 rounded-2xl border border-red-100",children:[e.jsx("div",{className:"w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-red-500/40",children:e.jsx(ie,{size:24})}),e.jsx("p",{className:"text-sm font-black text-red-600 mb-1",children:a("Request Declined")}),e.jsx("p",{className:"text-xs text-red-500/70 font-medium",children:a("The client has declined this chat request.")})]}):e.jsxs("form",{onSubmit:A,className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:d,onChange:t=>{N(t.target.value),g(!0)},placeholder:a("Type your message..."),className:"flex-1 bg-oflem-cream border-gray-border rounded-full px-6 py-4 text-sm font-medium focus:ring-2 focus:ring-oflem-terracotta focus:border-transparent transition-all"}),e.jsx("button",{type:"submit",disabled:!d.trim(),className:"w-14 h-14 bg-oflem-charcoal text-white rounded-full flex items-center justify-center hover:bg-black transition-all disabled:opacity-30 shadow-lg group",children:e.jsx(I,{size:24,className:"group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-6 text-oflem-terracotta/20",children:e.jsx(U,{size:48})}),e.jsx("h3",{className:"text-2xl font-black text-oflem-charcoal mb-2",children:a("Select a conversation")}),e.jsx("p",{className:"text-gray-muted font-bold",children:a("Choose a chat from the sidebar to start messaging")})]})})}),s&&e.jsxs("div",{className:"w-80 bg-white border-l border-gray-border flex flex-col overflow-y-auto",children:[e.jsx("div",{className:"p-6 border-b border-gray-border",children:e.jsx("h3",{className:"text-lg font-black text-oflem-charcoal mb-2",children:a("Mission Details")})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:a("Status")}),e.jsx("div",{className:`px-4 py-3 rounded-xl font-black text-sm text-center ${s.mission?.status==="OUVERTE"?"bg-blue-100 text-blue-700":s.mission?.status==="EN_NEGOCIATION"||s.mission?.status==="VERROUILLEE"?"bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light/20 text-oflem-terracotta":s.mission?.status==="EN_COURS"?"bg-yellow-100 text-yellow-700":s.mission?.status==="EN_VALIDATON"?"bg-orange-100 text-orange-700":s.mission?.status==="TERMINEE"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:s.mission?.status==="OUVERTE"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(te,{size:10,fill:"currentColor",className:"text-blue-500"})," ",a("Open")]}):s.mission?.status==="EN_NEGOCIATION"||s.mission?.status==="VERROUILLEE"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(se,{size:14})," ",a("Assigned")]}):s.mission?.status==="EN_COURS"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(X,{size:14,className:"animate-spin-slow"})," ",a("In Progress")]}):s.mission?.status==="EN_VALIDATON"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(z,{size:14})," ",a("In Validation")]}):s.mission?.status==="TERMINEE"?e.jsxs("span",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(O,{size:14})," ",a("Completed")]}):a(s.mission?.status||"Unknown")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:a("Budget")}),e.jsx("p",{className:"text-3xl font-black text-oflem-terracotta",children:s.mission?.budget?`€${s.mission.budget}`:a("Not set")})]}),s.mission?.deadline&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:a("Deadline")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{size:18,className:"text-oflem-terracotta"}),e.jsx("span",{className:"text-lg font-black text-oflem-charcoal",children:new Date(s.mission.deadline).toLocaleDateString()})]})]}),m(s)&&e.jsxs("div",{className:"elegant-capsule !p-4 !bg-oflem-cream/20 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs text-gray-muted font-black uppercase",children:a("Pending Offer")}),e.jsx("span",{className:"px-2 py-0.5 bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light text-oflem-charcoal text-[10px] font-black rounded text-uppercase",children:a("Pending")})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsxs("span",{className:"text-2xl font-black text-oflem-charcoal",children:["€",m(s).amount]}),e.jsx("span",{className:"text-xs text-gray-muted font-bold",children:a("Proposed")})]}),m(s).message&&e.jsxs("p",{className:"text-xs text-oflem-charcoal/70 italic leading-relaxed",children:['"',m(s).message,'"']}),s.mission?.user_id===o.user.id&&e.jsx("button",{onClick:()=>H(m(s)),className:"w-full py-3 bg-gradient-to-br from-oflem-terracotta to-oflem-terracotta-light text-oflem-charcoal font-black rounded-full hover:shadow-lg transition-all text-sm",children:a("Accept Offer")})]}),!m(s)&&s.mission?.user_id===o.user.id&&s.mission?.status==="OUVERTE"&&e.jsxs("div",{className:"p-4 bg-oflem-charcoal/5 border border-oflem-charcoal/10 rounded-2xl space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-muted font-black uppercase mb-1",children:a("Ready to start?")}),e.jsx("p",{className:"text-sm text-oflem-charcoal font-bold",children:a("Hire this person immediately")})]}),e.jsxs("button",{onClick:()=>$(u(s).id),className:"w-full py-3 bg-oflem-charcoal text-white font-black rounded-full hover:bg-black transition-all text-sm shadow-md flex items-center justify-center gap-2",children:[e.jsx(oe,{size:16})," ",a("Hire")," ",u(s).name]}),e.jsx("p",{className:"text-[10px] text-gray-muted text-center italic leading-tight",children:a("Hiring will secure the budget in escrow and assign the task.")})]}),s.mission?.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-muted font-bold uppercase mb-3",children:a("Description")}),e.jsx("p",{className:"text-sm text-oflem-charcoal font-medium leading-relaxed",children:s.mission.description})]}),e.jsxs(Y,{href:route("missions.show",s.mission_id),className:"w-full block text-center px-4 py-3 bg-oflem-charcoal text-white font-black rounded-full hover:bg-black transition-all",children:[a("View Full Mission")," ",e.jsx(ee,{size:16,className:"inline ml-1"})]})]})]})]}),e.jsx(ae,{show:q,clientSecret:V,onClose:()=>p(!1),onSuccess:()=>{p(!1),R.reload()}})]})}export{Te as default};
